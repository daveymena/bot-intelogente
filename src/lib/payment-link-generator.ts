/**
 * üí≥ GENERADOR DE LINKS DE PAGO
 * Genera links din√°micos de MercadoPago y PayPal seg√∫n el producto
 */

import { db } from './db'

export interface PaymentOptions {
  nequi: string
  daviplata: string
  mercadopago?: string
  paypal?: string
  transferencia: {
    banco: string
    cuenta: string
    titular: string
  }
}

export interface PaymentLinks {
  product: any
  methods: {
    nequi: string
    daviplata: string
    mercadopago?: string
    paypal?: string
    tarjeta?: string
    transferencia?: {
      banco: string
      cuenta: string
      titular: string
    }
  }
  instructions: string
}

export class PaymentLinkGenerator {
  // Configuraci√≥n de pagos
  private static readonly NEQUI_NUMBER = '3136174267'
  private static readonly DAVIPLATA_NUMBER = '3136174267'
  
  // Credenciales de MercadoPago (desde .env)
  private static readonly MERCADOPAGO_ACCESS_TOKEN = process.env.MERCADOPAGO_ACCESS_TOKEN || ''
  private static readonly MERCADOPAGO_PUBLIC_KEY = process.env.MERCADOPAGO_PUBLIC_KEY || ''
  
  // Credenciales de PayPal (desde .env)
  private static readonly PAYPAL_CLIENT_ID = process.env.PAYPAL_CLIENT_ID || ''
  private static readonly PAYPAL_CLIENT_SECRET = process.env.PAYPAL_CLIENT_SECRET || ''

  /**
   * Generar link de MercadoPago
   */
  static async generateMercadoPagoLink(
    productName: string,
    price: number,
    productId: string
  ): Promise<string | null> {
    try {
      if (!this.MERCADOPAGO_ACCESS_TOKEN) {
        console.log('[PaymentLink] MercadoPago no configurado')
        return null
      }

      // Llamar a API de MercadoPago para crear preferencia
      const response = await fetch('https://api.mercadopago.com/checkout/preferences', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.MERCADOPAGO_ACCESS_TOKEN}`
        },
        body: JSON.stringify({
          items: [
            {
              title: productName,
              quantity: 1,
              unit_price: price,
              currency_id: 'COP'
            }
          ],
          back_urls: {
            success: `${process.env.NEXT_PUBLIC_APP_URL}/payment/success?product=${productId}`,
            failure: `${process.env.NEXT_PUBLIC_APP_URL}/payment/failure?product=${productId}`,
            pending: `${process.env.NEXT_PUBLIC_APP_URL}/payment/pending?product=${productId}`
          },
          auto_return: 'approved',
          external_reference: productId,
          notification_url: `${process.env.NEXT_PUBLIC_APP_URL}/api/payments/webhook/mercadopago`
        })
      })

      if (!response.ok) {
        console.error('[PaymentLink] Error MercadoPago:', await response.text())
        return null
      }

      const data = await response.json()
      return data.init_point // Link de pago

    } catch (error) {
      console.error('[PaymentLink] Error generando link MercadoPago:', error)
      return null
    }
  }

  /**
   * Generar link de PayPal
   */
  static async generatePayPalLink(
    productName: string,
    price: number,
    productId: string
  ): Promise<string | null> {
    try {
      if (!this.PAYPAL_CLIENT_ID || !this.PAYPAL_CLIENT_SECRET) {
        console.log('[PaymentLink] PayPal no configurado')
        return null
      }

      // 1. Obtener token de acceso
      const authResponse = await fetch('https://api-m.paypal.com/v1/oauth2/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Authorization': `Basic ${Buffer.from(`${this.PAYPAL_CLIENT_ID}:${this.PAYPAL_CLIENT_SECRET}`).toString('base64')}`
        },
        body: 'grant_type=client_credentials'
      })

      if (!authResponse.ok) {
        console.error('[PaymentLink] Error auth PayPal')
        return null
      }

      const authData = await authResponse.json()
      const accessToken = authData.access_token

      // 2. Crear orden de pago
      const priceUSD = (price / 4000).toFixed(2) // Convertir COP a USD (aproximado)

      const orderResponse = await fetch('https://api-m.paypal.com/v2/checkout/orders', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${accessToken}`
        },
        body: JSON.stringify({
          intent: 'CAPTURE',
          purchase_units: [
            {
              reference_id: productId,
              description: productName,
              amount: {
                currency_code: 'USD',
                value: priceUSD
              }
            }
          ],
          application_context: {
            return_url: `${process.env.NEXT_PUBLIC_APP_URL}/payment/success?product=${productId}`,
            cancel_url: `${process.env.NEXT_PUBLIC_APP_URL}/payment/failure?product=${productId}`
          }
        })
      })

      if (!orderResponse.ok) {
        console.error('[PaymentLink] Error orden PayPal')
        return null
      }

      const orderData = await orderResponse.json()
      
      // Obtener link de aprobaci√≥n
      const approveLink = orderData.links.find((link: any) => link.rel === 'approve')
      return approveLink?.href || null

    } catch (error) {
      console.error('[PaymentLink] Error generando link PayPal:', error)
      return null
    }
  }

  /**
   * Generar todos los m√©todos de pago para un producto
   */
  static async generatePaymentLinks(productId: string): Promise<PaymentLinks | null> {
    try {
      // Obtener producto
      const product = await db.product.findUnique({
        where: { id: productId }
      })

      if (!product) {
        console.error('[PaymentLink] Producto no encontrado')
        return null
      }

      console.log(`[PaymentLink] Generando links para: ${product.name}`)

      // Generar links din√°micos
      const mercadopagoLink = await this.generateMercadoPagoLink(
        product.name,
        product.price,
        product.id
      )

      const paypalLink = await this.generatePayPalLink(
        product.name,
        product.price,
        product.id
      )

      // Construir respuesta
      const paymentLinks: PaymentLinks = {
        product,
        methods: {
          nequi: this.NEQUI_NUMBER,
          daviplata: this.DAVIPLATA_NUMBER,
          mercadopago: mercadopagoLink || undefined,
          paypal: paypalLink || undefined,
          tarjeta: mercadopagoLink || undefined, // MercadoPago acepta tarjetas
          transferencia: {
            banco: 'Bancolombia',
            cuenta: '12345678901',
            titular: 'Tecnovariedades D&S'
          }
        },
        instructions: this.generateInstructions(product, mercadopagoLink, paypalLink)
      }

      return paymentLinks

    } catch (error) {
      console.error('[PaymentLink] Error generando links:', error)
      return null
    }
  }

  /**
   * Generar instrucciones de pago
   */
  private static generateInstructions(
    product: any,
    mercadopagoLink: string | null,
    paypalLink: string | null
  ): string {
    const emoji = this.getProductEmoji(product)
    let instructions = `üí≥ **M√âTODOS DE PAGO PARA ${product.name}** ${emoji}\n\n`
    instructions += `üí∞ Precio: ${product.price.toLocaleString('es-CO')} COP\n\n`
    instructions += `Elige tu m√©todo de pago preferido:\n\n`

    // 1. Nequi/Daviplata
    instructions += `1Ô∏è‚É£ **NEQUI / DAVIPLATA**\n`
    instructions += `   üì± N√∫mero: ${this.NEQUI_NUMBER}\n`
    instructions += `   ‚úÖ Transferencia instant√°nea\n`
    instructions += `   üí° Env√≠a comprobante por WhatsApp\n\n`

    // 2. Tarjeta de cr√©dito (MercadoPago)
    if (mercadopagoLink) {
      instructions += `2Ô∏è‚É£ **TARJETA DE CR√âDITO/D√âBITO**\n`
      instructions += `   üí≥ Pago seguro con MercadoPago\n`
      instructions += `   üëâ ${mercadopagoLink}\n`
      instructions += `   ‚úÖ Acceso inmediato\n\n`
    }

    // 3. PayPal
    if (paypalLink) {
      instructions += `3Ô∏è‚É£ **PAYPAL**\n`
      instructions += `   üåé Pago internacional\n`
      instructions += `   üëâ ${paypalLink}\n`
      instructions += `   ‚úÖ Seguro y confiable\n\n`
    }

    // 4. Transferencia bancaria
    instructions += `4Ô∏è‚É£ **TRANSFERENCIA BANCARIA**\n`
    instructions += `   üè¶ Banco: Bancolombia\n`
    instructions += `   üìã Cuenta: 12345678901\n`
    instructions += `   üë§ Titular: Tecnovariedades D&S\n`
    instructions += `   üí° Env√≠a comprobante por WhatsApp\n\n`

    instructions += `üìû **Soporte:** +57 304 274 8687\n`
    instructions += `üìß **Email:** deinermen25@gmail.com\n\n`
    instructions += `¬øCon cu√°l m√©todo deseas pagar?`

    return instructions
  }

  /**
   * Obtener emoji seg√∫n producto
   */
  private static getProductEmoji(product: any): string {
    const name = product.name.toLowerCase()
    if (name.includes('piano') || name.includes('m√∫sica')) return 'üéπ'
    if (name.includes('laptop') || name.includes('computador')) return 'üíª'
    if (name.includes('macbook')) return 'üçé'
    if (name.includes('moto')) return 'üèçÔ∏è'
    if (name.includes('curso') || name.includes('mega')) return 'üìö'
    return '‚ú®'
  }

  /**
   * Formatear respuesta para WhatsApp
   */
  static formatForWhatsApp(paymentLinks: PaymentLinks): string {
    return paymentLinks.instructions
  }

  /**
   * Generar respuesta seg√∫n m√©todo elegido
   */
  static generateMethodResponse(method: string, paymentLinks: PaymentLinks): string {
    const emoji = this.getProductEmoji(paymentLinks.product)
    const price = paymentLinks.product.price.toLocaleString('es-CO')

    switch (method.toLowerCase()) {
      case 'nequi':
      case 'daviplata':
      case '1':
        return `‚úÖ **PAGO POR NEQUI/DAVIPLATA** ${emoji}\n\n` +
               `üì± N√∫mero: ${paymentLinks.methods.nequi}\n` +
               `üí∞ Monto: ${price} COP\n\n` +
               `**Pasos:**\n` +
               `1. Abre tu app Nequi o Daviplata\n` +
               `2. Env√≠a ${price} COP al n√∫mero ${paymentLinks.methods.nequi}\n` +
               `3. Toma captura del comprobante\n` +
               `4. Env√≠alo por este chat\n\n` +
               `‚úÖ Recibir√°s tu producto inmediatamente despu√©s de verificar el pago`

      case 'tarjeta':
      case 'credito':
      case 'debito':
      case '2':
        if (paymentLinks.methods.mercadopago) {
          return `‚úÖ **PAGO CON TARJETA** ${emoji}\n\n` +
                 `üí≥ Pago seguro con MercadoPago\n` +
                 `üí∞ Monto: ${price} COP\n\n` +
                 `üëâ Link de pago:\n${paymentLinks.methods.mercadopago}\n\n` +
                 `**Pasos:**\n` +
                 `1. Haz clic en el link\n` +
                 `2. Ingresa los datos de tu tarjeta\n` +
                 `3. Confirma el pago\n\n` +
                 `‚úÖ Acceso inmediato despu√©s del pago`
        }
        return `‚ö†Ô∏è Pago con tarjeta no disponible. Elige otro m√©todo.`

      case 'paypal':
      case '3':
        if (paymentLinks.methods.paypal) {
          return `‚úÖ **PAGO CON PAYPAL** ${emoji}\n\n` +
                 `üåé Pago internacional seguro\n` +
                 `üí∞ Monto: ${price} COP\n\n` +
                 `üëâ Link de pago:\n${paymentLinks.methods.paypal}\n\n` +
                 `**Pasos:**\n` +
                 `1. Haz clic en el link\n` +
                 `2. Inicia sesi√≥n en PayPal\n` +
                 `3. Confirma el pago\n\n` +
                 `‚úÖ Acceso inmediato despu√©s del pago`
        }
        return `‚ö†Ô∏è PayPal no disponible. Elige otro m√©todo.`

      case 'transferencia':
      case 'bancaria':
      case '4':
        return `‚úÖ **TRANSFERENCIA BANCARIA** ${emoji}\n\n` +
               `üè¶ Banco: ${paymentLinks.methods.transferencia?.banco}\n` +
               `üìã Cuenta: ${paymentLinks.methods.transferencia?.cuenta}\n` +
               `üë§ Titular: ${paymentLinks.methods.transferencia?.titular}\n` +
               `üí∞ Monto: ${price} COP\n\n` +
               `**Pasos:**\n` +
               `1. Realiza la transferencia desde tu banco\n` +
               `2. Toma captura del comprobante\n` +
               `3. Env√≠alo por este chat\n\n` +
               `‚úÖ Recibir√°s tu producto despu√©s de verificar el pago`

      default:
        return paymentLinks.instructions
    }
  }
}
