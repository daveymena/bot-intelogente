/**
 * üß† SERVICIO DE INTELIGENCIA DE PRODUCTOS
 * Maneja respuestas espec√≠ficas e inteligentes sobre productos
 */

import { db } from './db'

export interface ProductIntent {
    type: 'info' | 'price' | 'link' | 'buy' | 'availability' | 'general'
    confidence: number
    keywords: string[]
}

export interface ProductResponse {
    text: string
    product: any
    intent: ProductIntent
    hasLinks: boolean
    links?: {
        info?: string
        buy?: string
    }
    images?: string[]
}

export class ProductIntelligenceService {
    /**
     * Extraer palabras clave del mensaje
     */
    private static extractKeywords(query: string): string[] {
        const queryLower = query.toLowerCase()

        // Palabras a ignorar (stop words) - AMPLIADO
        const stopWords = [
            'info', 'informaci√≥n', 'informacion', 'dame', 'el', 'la', 'los', 'las',
            'un', 'una', 'del', 'de', 'cu√°nto', 'cuanto', 'cuesta', 'precio',
            'quiero', 'deseo', 'necesito', 'busco', 'hay', 'tienes', 'tienen', 'tiene',
            'disponible', 'link', 'enlace', 'comprar', 'sobre', 'acerca', 'ese',
            'esa', 'esto', 'esta', 'para', 'por', 'con', 'sin', 'm√°s', 'mas',
            'sus', 'papeles', 'd√≠a', 'dia', 'documentos', 'garant√≠a', 'garantia',
            'color', 'colores', 'env√≠o', 'envio', 'entrega', 'pago', 'pagos',
            'm√©todos', 'metodos', 'forma', 'formas', 'como', 'c√≥mo', 'que', 'qu√©',
            'ver', 'veo', 'vea', 'veas', 'ves', 'fotos', 'foto', 'imagen', 'imagenes',
            'detalles', 'detalle', 'caracter√≠sticas', 'caracteristicas', 'especificaciones',
            'saber', 'conocer', 'mostrar', 'muestra', 'muestrame', 'mu√©strame',
            'enviar', 'envia', 'env√≠a', 'manda', 'mandar', 'pasa', 'pasar',
            'puedes', 'puede', 'podr√≠a', 'podria', 'podr√≠as', 'podrias',
            'gustar√≠a', 'gustaria', 'quisiera', 'me', 'te', 'le', 'nos', 'les',
            'si', 's√≠', 'no', 'tal', 'vez', 'quiz√°', 'quiz√°s', 'quiza', 'quizas'
        ]

        // Dividir en palabras y filtrar
        const words = queryLower
            .split(/\s+/)
            .map(word => word.replace(/[?¬ø!¬°.,;:]/g, '')) // Quitar puntuaci√≥n de cada palabra
            .filter(word => word.length > 2) // Palabras de m√°s de 2 caracteres
            .filter(word => !stopWords.includes(word))

        return words
    }

    /**
     * Buscar producto espec√≠fico en la base de datos
     */
    static async findProduct(query: string, userId: string): Promise<any | null> {
        try {
            console.log(`üîç [Product Intelligence] Buscando producto: "${query}"`)

            // Extraer palabras clave del mensaje
            const keywords = this.extractKeywords(query)
            console.log(`üîë [Product Intelligence] Palabras clave: ${keywords.join(', ')}`)

            // ‚ö†Ô∏è IMPORTANTE: Si no hay palabras clave significativas, NO buscar
            // Esto evita b√∫squedas incorrectas con mensajes gen√©ricos como "ver m√°s informaci√≥n"
            if (keywords.length === 0) {
                console.log(`‚ùå [Product Intelligence] No hay palabras clave significativas - usar contexto de memoria`)
                return null
            }

            // üö® DETECTAR SI BUSCA ESPEC√çFICAMENTE NUEVO O USADO
            const buscaUsado = queryLower.includes('usado') || 
                               queryLower.includes('usada') || 
                               queryLower.includes('segunda mano') ||
                               queryLower.includes('reacondicionado')
            
            const buscaNuevo = queryLower.includes('nuevo') || 
                               queryLower.includes('nueva') ||
                               queryLower.includes('0 km') ||
                               queryLower.includes('sin usar')

            console.log(`üîç [Product Intelligence] Filtro - Usado: ${buscaUsado}, Nuevo: ${buscaNuevo}`)

            // Obtener todos los productos disponibles
            const allProducts = await db.product.findMany({
                where: {
                    userId,
                    status: 'AVAILABLE'
                }
            })

            if (allProducts.length === 0) {
                console.log(`‚ùå [Product Intelligence] No hay productos disponibles`)
                return null
            }

            // üö® FILTRAR POR CONDICI√ìN SI SE ESPECIFIC√ì
            let filteredProducts = allProducts

            if (buscaUsado) {
                filteredProducts = allProducts.filter(p => {
                    const nameLower = p.name.toLowerCase()
                    const descLower = (p.description || '').toLowerCase()
                    const esUsado = nameLower.includes('usado') || 
                                    nameLower.includes('usada') ||
                                    descLower.includes('usado') ||
                                    descLower.includes('usada')
                    return esUsado
                })
                console.log(`üîç [Product Intelligence] Filtrados ${filteredProducts.length} productos USADOS`)
            } else if (buscaNuevo) {
                filteredProducts = allProducts.filter(p => {
                    const nameLower = p.name.toLowerCase()
                    const descLower = (p.description || '').toLowerCase()
                    const esUsado = nameLower.includes('usado') || 
                                    nameLower.includes('usada') ||
                                    descLower.includes('usado') ||
                                    descLower.includes('usada')
                    return !esUsado // Solo productos que NO son usados
                })
                console.log(`üîç [Product Intelligence] Filtrados ${filteredProducts.length} productos NUEVOS`)
            }

            if (filteredProducts.length === 0) {
                console.log(`‚ùå [Product Intelligence] No hay productos ${buscaUsado ? 'USADOS' : 'NUEVOS'} disponibles`)
                return null
            }

            // Buscar coincidencias espec√≠ficas primero (incluyendo palabras del mensaje original)
            const queryLower = query.toLowerCase()
            const specificMatches = [
                { keywords: ['piano'], name: 'piano', searchIn: 'name' },
                { keywords: ['macbook', 'mac', 'apple'], name: 'macbook', searchIn: 'name' },
                { keywords: ['moto', 'pulsar', 'bajaj'], name: 'bajaj', searchIn: 'name' },
                { keywords: ['asus', 'vivobook'], name: 'asus', searchIn: 'name' },
                { keywords: ['laptop', 'laptops', 'portatil', 'computador', 'computadora'], name: 'laptop', searchIn: 'name' },
                { keywords: ['hp'], name: 'hp', searchIn: 'name' },
                { keywords: ['lenovo'], name: 'lenovo', searchIn: 'name' },
                { keywords: ['mega', 'pack', 'megapack'], name: 'mega pack', searchIn: 'name' }
            ]

            // Buscar por coincidencias espec√≠ficas (buscar en el mensaje original, no solo en keywords)
            for (const match of specificMatches) {
                const hasKeywordInQuery = match.keywords.some(kw => queryLower.includes(kw))
                if (hasKeywordInQuery) {
                    // Buscar producto que contenga el nombre en su nombre o descripci√≥n
                    // üö® USAR filteredProducts en lugar de allProducts
                    const found = filteredProducts.find(p => {
                        const nameLower = p.name.toLowerCase()
                        const descLower = (p.description || '').toLowerCase()
                        
                        // Para "laptop", buscar cualquier laptop
                        if (match.name === 'laptop') {
                            return nameLower.includes('laptop') || 
                                   nameLower.includes('asus') || 
                                   nameLower.includes('hp') || 
                                   nameLower.includes('lenovo') ||
                                   nameLower.includes('macbook') ||
                                   descLower.includes('laptop')
                        }
                        
                        // Buscar en nombre (ya est√° en min√∫sculas)
                        return nameLower.includes(match.name)
                    })
                    
                    if (found) {
                        console.log(`‚úÖ [Product Intelligence] Producto espec√≠fico encontrado: ${found.name}`)
                        return found
                    }
                }
            }

            // Buscar por cualquier palabra clave en nombre, descripci√≥n o tags
            // üö® USAR filteredProducts en lugar de allProducts
            const scoredProducts = filteredProducts.map(p => {
                let score = 0
                const nameLower = p.name.toLowerCase()
                const descLower = (p.description || '').toLowerCase()
                const tagsLower = (p.tags || '').toLowerCase()

                keywords.forEach(keyword => {
                    const keywordLower = keyword.toLowerCase() // Asegurar min√∫sculas
                    
                    // Coincidencia exacta en nombre vale mucho m√°s
                    if (nameLower.includes(keywordLower)) score += 15
                    if (descLower.includes(keywordLower)) score += 3
                    if (tagsLower.includes(keywordLower)) score += 2
                    
                    // Bonus: coincidencia al inicio del nombre
                    if (nameLower.startsWith(keywordLower)) score += 5
                    
                    // Bonus: palabra completa en el nombre
                    const nameWords = nameLower.split(/\s+/)
                    if (nameWords.some(word => word === keywordLower)) score += 10
                })

                return { product: p, score }
            })

            // Ordenar por score y tomar el mejor
            // Score m√≠nimo reducido a 5 para ser m√°s flexible
            const bestMatch = scoredProducts
                .filter(sp => sp.score >= 5)
                .sort((a, b) => b.score - a.score)[0]

            if (bestMatch) {
                console.log(`‚úÖ [Product Intelligence] Producto encontrado: ${bestMatch.product.name} (score: ${bestMatch.score})`)
                return bestMatch.product
            }

            console.log(`‚ùå [Product Intelligence] No se encontraron productos con suficiente coincidencia (score m√≠nimo: 5)`)
            return null

        } catch (error) {
            console.error('‚ùå [Product Intelligence] Error buscando producto:', error)
            return null
        }
    }

    /**
     * Detectar la intenci√≥n del cliente
     */
    static detectIntent(message: string): ProductIntent {
        const messageLower = message.toLowerCase()

        // Intenci√≥n: LINK/ENLACE
        if (/(link|enlace|url|p√°gina|pagina|dame el|env√≠a|envia|manda|pasa).*(link|enlace|url|p√°gina|pagina)/i.test(messageLower) ||
            /^(link|enlace|url)$/i.test(messageLower)) {
            return {
                type: 'link',
                confidence: 0.95,
                keywords: ['link', 'enlace', 'url']
            }
        }

        // Intenci√≥n: COMPRAR
        if (/(quiero|deseo|me gustar√≠a|quisiera).*(comprar|adquirir|pedir|ordenar)/i.test(messageLower) ||
            /(comprar|compra|pedido|orden)/i.test(messageLower)) {
            return {
                type: 'buy',
                confidence: 0.95,
                keywords: ['comprar', 'pedido']
            }
        }

        // Intenci√≥n: PRECIO
        if (/(cu√°nto|cuanto|precio|cuesta|valor|vale|costo)/i.test(messageLower)) {
            return {
                type: 'price',
                confidence: 0.9,
                keywords: ['precio', 'cuesta']
            }
        }

        // Intenci√≥n: DISPONIBILIDAD
        if (/(disponible|stock|hay|tienen|tienes|queda|quedan)/i.test(messageLower)) {
            return {
                type: 'availability',
                confidence: 0.85,
                keywords: ['disponible', 'stock']
            }
        }

        // Intenci√≥n: INFORMACI√ìN
        if (/(info|informaci√≥n|informacion|detalles|caracter√≠sticas|caracteristicas|especificaciones|sobre|acerca)/i.test(messageLower)) {
            return {
                type: 'info',
                confidence: 0.9,
                keywords: ['info', 'detalles']
            }
        }

        // Por defecto: GENERAL
        return {
            type: 'general',
            confidence: 0.7,
            keywords: []
        }
    }

    /**
     * Extraer enlaces del producto (SOLO para productos digitales)
     */
    static extractLinks(product: any): { info?: string, buy?: string, mercadopago?: string, paypal?: string, contacto?: string } {
        const links: { info?: string, buy?: string, mercadopago?: string, paypal?: string, contacto?: string } = {}

        try {
            // Intentar parsear tags como JSON
            const tags = product.tags ? JSON.parse(product.tags) : []

            for (const tag of tags) {
                if (typeof tag === 'string') {
                    // Extraer tags con prefijos de m√©todos de pago
                    if (tag.startsWith('hotmart:')) {
                        links.buy = tag.replace('hotmart:', '')
                    } else if (tag.startsWith('mercadopago:')) {
                        links.mercadopago = tag.replace('mercadopago:', '')
                    } else if (tag.startsWith('paypal:')) {
                        links.paypal = tag.replace('paypal:', '')
                    } else if (tag.startsWith('contacto:')) {
                        links.contacto = tag.replace('contacto:', '')
                    } else if (tag.startsWith('http')) {
                        // URLs sin prefijo
                        if (tag.includes('pay.hotmart') || tag.includes('checkout') || tag.includes('buy')) {
                            links.buy = tag
                        } else if (tag.includes('landein') || tag.includes('page') || tag.includes('info')) {
                            links.info = tag
                        } else if (!links.info) {
                            links.info = tag
                        }
                    }
                }
            }
        } catch (e) {
            // Si no es JSON, buscar URLs en el string
            const urlRegex = /(https?:\/\/[^\s,]+)/g
            const matches = product.tags?.match(urlRegex) || []

            for (const url of matches) {
                if (url.includes('pay.hotmart') || url.includes('checkout')) {
                    links.buy = url
                } else if (!links.info) {
                    links.info = url
                }
            }
        }

        // ‚ö†Ô∏è SOLO GENERAR ENLACES PARA PRODUCTOS DIGITALES
        // Productos f√≠sicos NO tienen links de pago autom√°ticos
        if (product.category === 'DIGITAL') {
            // Si no tiene MercadoPago configurado, no generar
            // Solo usar los links que est√°n en los tags
            if (!links.buy && !links.mercadopago && !links.paypal) {
                // No generar links din√°micos, dejar vac√≠o
                // El bot ofrecer√° contacto directo
            }
        } else {
            // Productos f√≠sicos: NUNCA generar links de pago
            // Limpiar cualquier link que se haya extra√≠do por error
            links.buy = undefined
            links.mercadopago = undefined
            links.paypal = undefined
            
            // Agregar contacto directo
            links.contacto = '+57 304 274 8687'
        }

        return links
    }



    /**
     * Extraer im√°genes del producto
     */
    static extractImages(product: any): string[] {
        try {
            return product.images ? JSON.parse(product.images) : []
        } catch (e) {
            return []
        }
    }

    /**
     * Generar respuesta seg√∫n la intenci√≥n
     */
    static async generateResponse(
        product: any,
        intent: ProductIntent,
        context?: any
    ): Promise<ProductResponse> {
        const links = this.extractLinks(product)
        const images = this.extractImages(product)
        const hasLinks = !!(links.info || links.buy)

        // Emoji seg√∫n categor√≠a
        const emoji = this.getProductEmoji(product)

        let text = ''

        switch (intent.type) {
            case 'info':
                text = this.generateInfoResponse(product, emoji, links, images)
                break

            case 'price':
                text = this.generatePriceResponse(product, emoji, links)
                break

            case 'link':
                text = this.generateLinkResponse(product, emoji, links)
                break

            case 'buy':
                text = this.generateBuyResponse(product, emoji, links)
                break

            case 'availability':
                text = this.generateAvailabilityResponse(product, emoji)
                break

            default:
                text = this.generateGeneralResponse(product, emoji, links, images)
        }

        return {
            text,
            product,
            intent,
            hasLinks,
            links,
            images
        }
    }

    /**
     * Generar respuesta de INFORMACI√ìN
     */
    private static generateInfoResponse(product: any, emoji: string, links: any, images: string[]): string {
        let response = `${emoji} **${product.name}**\n\n`

        if (product.description) {
            // Extraer caracter√≠sticas si est√°n en formato de lista
            const lines = product.description.split(/[,\n]/).filter((l: string) => l.trim())
            if (lines.length > 1) {
                lines.slice(0, 5).forEach((line: string) => {
                    response += `‚úÖ ${line.trim()}\n`
                })
            } else {
                response += `${product.description}\n\n`
            }
        }

        response += `\nüí∞ Precio: $${product.price.toLocaleString('es-CO')} COP\n`

        if (product.stock) {
            response += `üì¶ ${product.stock} unidades disponibles\n`
        }

        if (images.length > 0) {
            response += `üì∏ ${images.length} foto${images.length > 1 ? 's' : ''} disponible${images.length > 1 ? 's' : ''}\n`
        }

        response += `\n¬øTe interesa?`

        return response
    }

    /**
     * Generar respuesta de PRECIO
     */
    private static generatePriceResponse(product: any, emoji: string, links: any): string {
        let response = `El ${product.name} cuesta $${product.price.toLocaleString('es-CO')} COP ${emoji}\n\n`

        if (product.stock) {
            response += `Tenemos ${product.stock} unidades disponibles.\n`
        }

        if (links.buy) {
            response += `¬øDeseas el enlace de compra?`
        } else {
            response += `¬øDeseas m√°s informaci√≥n o hacer el pedido?`
        }

        return response
    }

    /**
     * Generar respuesta de LINK
     */
    private static generateLinkResponse(product: any, emoji: string, links: any): string {
        // Productos f√≠sicos: SIEMPRE contacto directo
        if (product.category === 'PHYSICAL') {
            return `Para adquirir ${product.name} ${emoji}, cont√°ctanos directamente:\n\nüìû WhatsApp: +57 304 274 8687\nüìß deinermen25@gmail.com\nüìç Centro Comercial El Diamante 2, San Nicol√°s, Cali\n\nM√©todos de pago:\n‚úÖ Efectivo\n‚úÖ Transferencia\n‚úÖ Nequi/Daviplata\n‚úÖ Tarjeta`
        }

        // Productos digitales: Verificar si tiene links
        if (!links.buy && !links.mercadopago && !links.paypal) {
            return `Para adquirir ${product.name} ${emoji}, cont√°ctanos:\n\nüì± WhatsApp: +57 304 274 8687\nüìß deinermen25@gmail.com`
        }

        let response = `¬°Perfecto! ${emoji}\n\n`

        if (links.buy) {
            response += `Aqu√≠ est√° el enlace de compra:\nüëâ ${links.buy}\n\n`
        }

        if (links.mercadopago && !links.buy) {
            response += `Mercado Pago:\nüëâ ${links.mercadopago}\n\n`
        }

        if (links.info) {
            response += `Tambi√©n puedes ver m√°s info aqu√≠:\nüìÑ ${links.info}\n\n`
        }

        response += `Acceso inmediato despu√©s del pago ‚úÖ`

        return response
    }

    /**
     * Generar respuesta de COMPRA
     */
    private static generateBuyResponse(product: any, emoji: string, links: any): string {
        let response = `¬°Excelente decisi√≥n! üéâ\n\n`
        response += `${product.name}: ${product.price.toLocaleString('es-CO')} COP\n\n`

        // Productos f√≠sicos: SIEMPRE contacto directo
        if (product.category === 'PHYSICAL') {
            response += `Para hacer tu pedido:\nüì± WhatsApp: +57 304 274 8687\nüìß deinermen25@gmail.com\nüìç Centro Comercial El Diamante 2, San Nicol√°s, Cali\n\nM√©todos de pago:\n‚úÖ Efectivo\n‚úÖ Transferencia\n‚úÖ Nequi/Daviplata\n‚úÖ Tarjeta`
            return response
        }

        // Productos digitales: Verificar links
        if (links.buy) {
            response += `Compra aqu√≠:\nüëâ ${links.buy}\n\n`
            response += `Acceso inmediato despu√©s del pago ‚úÖ`
        } else if (links.mercadopago) {
            response += `Compra aqu√≠:\nüëâ ${links.mercadopago}\n\n`
            response += `Acceso inmediato despu√©s del pago ‚úÖ`
        } else {
            response += `Para hacer tu pedido:\nüì± WhatsApp: +57 304 274 8687\nüìß deinermen25@gmail.com\n\n`
            response += `¬øNecesitas ayuda con algo m√°s?`
        }

        return response
    }

    /**
     * Generar respuesta de DISPONIBILIDAD
     */
    private static generateAvailabilityResponse(product: any, emoji: string): string {
        let response = `${emoji} ${product.name}\n\n`

        if (product.stock && product.stock > 0) {
            response += `‚úÖ Disponible: ${product.stock} unidad${product.stock > 1 ? 'es' : ''}\n\n`
            response += `¬øTe gustar√≠a hacer el pedido?`
        } else if (product.category === 'DIGITAL') {
            response += `‚úÖ Disponible (producto digital)\n\n`
            response += `Acceso inmediato despu√©s de la compra`
        } else {
            response += `‚ö†Ô∏è Consultar disponibilidad\n\n`
            response += `Cont√°ctanos para verificar stock:\nüì± +57 304 274 8687`
        }

        return response
    }

    /**
     * Generar respuesta GENERAL
     */
    private static generateGeneralResponse(product: any, emoji: string, links: any, images: string[]): string {
        let response = `${emoji} **${product.name}**\n\n`
        response += `üí∞ $${product.price.toLocaleString('es-CO')} COP\n`

        if (product.stock) {
            response += `üì¶ ${product.stock} disponibles\n`
        }

        if (images.length > 0) {
            response += `üì∏ ${images.length} fotos\n`
        }

        response += `\n¬øQu√© te gustar√≠a saber?`

        return response
    }

    /**
     * Obtener emoji seg√∫n el producto
     */
    private static getProductEmoji(product: any): string {
        const name = product.name.toLowerCase()

        if (name.includes('piano') || name.includes('m√∫sica')) return 'üéπ'
        if (name.includes('laptop') || name.includes('computador')) return 'üíª'
        if (name.includes('macbook') || name.includes('apple')) return 'üçé'
        if (name.includes('moto') || name.includes('pulsar')) return 'üèçÔ∏è'
        if (name.includes('curso') || name.includes('mega pack')) return 'üìö'
        if (name.includes('memoria') || name.includes('ram')) return 'üíæ'
        if (name.includes('ssd') || name.includes('disco')) return 'üíø'
        if (name.includes('morral') || name.includes('mochila')) return 'üéí'

        return '‚ú®'
    }

    /**
     * Extraer informaci√≥n estructurada del producto para la IA
     */
    static extractProductInfo(product: any): any {
        return {
            name: product.name,
            price: product.price,
            priceFormatted: `$${product.price.toLocaleString('es-CO')} COP`,
            category: product.category,
            description: product.description || '',
            stock: product.stock,
            images: this.extractImages(product),
            links: this.extractLinks(product),
            emoji: this.getProductEmoji(product),
            isDigital: product.category === 'DIGITAL',
            isPhysical: product.category === 'PHYSICAL'
        }
    }

    /**
     * Generar respuesta est√°tica como fallback (si falla la IA)
     */
    static generateStaticResponse(product: any, intent: any): string {
        const emoji = this.getProductEmoji(product)
        const links = this.extractLinks(product)

        switch (intent.type) {
            case 'info':
                return `${emoji} ${product.name}\n\nüí∞ $${product.price.toLocaleString('es-CO')} COP\n\n${product.description || 'Excelente producto disponible'}\n\n¬øTe interesa?`

            case 'price':
                return `${emoji} ${product.name} cuesta $${product.price.toLocaleString('es-CO')} COP\n\n¬øDeseas m√°s informaci√≥n?`

            case 'link':
                if (links.buy) {
                    return `¬°Perfecto! ${emoji}\n\nEnlace de compra:\n${links.buy}\n\n¬øAlguna duda?`
                }
                return `Para adquirir ${product.name}, cont√°ctanos:\nüì± +57 304 274 8687`

            case 'buy':
                return `¬°Excelente! ${emoji}\n\n${product.name}: $${product.price.toLocaleString('es-CO')} COP\n\n¬øConfirmamos tu pedido?`

            default:
                return `${emoji} ${product.name} - $${product.price.toLocaleString('es-CO')} COP\n\n¬øQu√© te gustar√≠a saber?`
        }
    }
}
