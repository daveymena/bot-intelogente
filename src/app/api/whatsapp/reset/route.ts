import { NextResponse } from 'next/server'
import { promises as fs } from 'fs'
import path from 'path'

export async function POST() {
  try {
    console.log('[WhatsApp Reset] üîÑ Limpiando sesi√≥n...')

    // Ruta de la carpeta de sesiones
    const sessionsPath = path.join(process.cwd(), 'auth_sessions')
    
    try {
      // Intentar eliminar toda la carpeta de sesiones
      await fs.rm(sessionsPath, { recursive: true, force: true })
      console.log('[WhatsApp Reset] ‚úÖ Carpeta de sesiones eliminada')
    } catch (error) {
      console.log('[WhatsApp Reset] ‚ö†Ô∏è No se pudo eliminar carpeta:', error)
    }

    // Recrear la carpeta vac√≠a
    try {
      await fs.mkdir(sessionsPath, { recursive: true })
      console.log('[WhatsApp Reset] ‚úÖ Carpeta de sesiones recreada')
    } catch (error) {
      console.log('[WhatsApp Reset] ‚ö†Ô∏è Error recreando carpeta:', error)
    }

    // Notificar al sistema que debe reiniciar la conexi√≥n
    console.log('[WhatsApp Reset] ‚úÖ Sesi√≥n limpiada exitosamente')

    return NextResponse.json({
      success: true,
      message: 'Sesi√≥n limpiada. Por favor, reconecta para generar un nuevo QR.'
    })
  } catch (error) {
    console.error('[WhatsApp Reset] ‚ùå Error:', error)
    return NextResponse.json(
      {
        success: false,
        error: 'Error al limpiar la sesi√≥n'
      },
      { status: 500 }
    )
  }
}
