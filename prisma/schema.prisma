generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String              @id @default(cuid())
  email                    String              @unique
  name                     String?
  phone                    String?
  password                 String
  role                     UserRole            @default(USER)
  membershipType           MembershipType      @default(FREE)
  membershipEnds           DateTime?
  trialEnds                DateTime?
  isActive                 Boolean             @default(true)
  isEmailVerified          Boolean             @default(false)
  emailVerificationToken   String?
  isPhoneVerified          Boolean             @default(false)
  phoneVerificationCode    String?
  phoneVerificationExpires DateTime?
  passwordResetToken       String?
  passwordResetExpires     DateTime?
  apiKey                   String?             @unique
  whatsappNumber           String?
  businessName             String?
  businessAddress          String?
  businessPhone            String?
  businessHours            String?
  businessDescription      String?
  adminNotificationPhone   String?             @default("3005560186")
  lastLoginAt              DateTime?
  stripeCustomerId         String?             @unique
  subscriptionPlan         String?             @default("free")
  subscriptionStatus       String?             @default("trial")
  subscriptionExpiresAt    DateTime?
  paymentMethods           String?
  businessInfo             String?
  notificationSettings     String?
  createdAt                DateTime            @default(now())
  updatedAt                DateTime            @updatedAt
  paymentIntegration       PaymentIntegration?
  storeSettings            StoreSettings?
  aiPrompts                AIPrompt[]
  appointments             Appointment[]
  settings                 BotSettings?
  businessSettings         BusinessSettings?
  categories               Category[]
  conversations            Conversation[]
  notificationTokens       NotificationToken[]
  paymentConfig            PaymentConfig?
  payments                 Payment[]
  products                 Product[]
  salesFlowConfig          SalesFlowConfig?
  sessions                 Session[]
  subscriptions            Subscription?
  trainingData             TrainingData[]
  usageMetrics             UsageMetric[]
  whatsappConnection       WhatsAppConnection?

  @@map("users")
}

model Product {
  id                       String         @id @default(cuid())
  name                     String
  description              String?
  price                    Float
  currency                 String         @default("COP")
  category                 ProductType
  customCategory           String?
  store                    String?
  status                   ProductStatus  @default(AVAILABLE)
  images                   String?
  tags                     String?
  autoResponse             String?
  stock                    Int?
  smartTags                String?
  tagCategory              String?
  searchPriority           Int            @default(5)
  autoTagged               Boolean        @default(false)
  mainCategory             String?
  productTags              String?
  isAccessory              Boolean        @default(false)
  parentCategory           String?
  categorizedAt            DateTime?
  categorizedBy            String?
  categorizationConfidence Float?
  paymentLinkMercadoPago   String?
  paymentLinkPayPal        String?
  paymentLinkCustom        String?
  landingPageContent       String?
  userId                   String
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt
  deliveryLink             String?
  conversations            Conversation[]
  landingPages             LandingPage[]
  user                     User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([category, mainCategory])
  @@index([store])
  @@map("products")
}

model Conversation {
  id                  String             @id @default(cuid())
  customerPhone       String
  customerName        String?
  status              ConversationStatus @default(ACTIVE)
  lastMessageAt       DateTime           @default(now())
  userId              String
  productId           String?
  productName         String?
  needsHumanAttention Boolean            @default(false)
  escalationReason    String?
  escalationCategory  String?
  escalatedAt         DateTime?
  resolvedAt          DateTime?
  appointments        Appointment[]
  product             Product?           @relation(fields: [productId], references: [id])
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages            Message[]
  trainingData        TrainingData[]

  @@index([needsHumanAttention])
  @@map("conversations")
}

model Message {
  id             String           @id @default(cuid())
  content        String
  type           MessageType      @default(TEXT)
  direction      MessageDirection
  aiGenerated    Boolean          @default(false)
  confidence     Float?
  conversationId String
  createdAt      DateTime         @default(now())
  conversation   Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model AIPrompt {
  id        String     @id @default(cuid())
  name      String
  prompt    String
  type      PromptType
  isActive  Boolean    @default(true)
  userId    String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_prompts")
}

model BotSettings {
  id                  String   @id @default(cuid())
  userId              String   @unique
  businessName        String   @default("Tecnovariedades D&S")
  businessPhone       String
  businessHours       String?
  businessAddress     String?
  whatsappNumber      String?
  shippingInfo        String?
  warrantyInfo        String?
  botPersonality      String?
  groqApiKey          String?
  openaiApiKey        String?
  claudeApiKey        String?
  geminiApiKey        String?
  mistralApiKey       String?
  anthropicApiKey     String?
  openrouterApiKey    String?
  ollamaBaseUrl       String?
  ollamaModel         String?  @default("llama3.1")
  preferredAiProvider String   @default("groq")
  aiProviderPriority  String   @default("[\"groq\",\"openai\",\"gemini\",\"claude\",\"mistral\"]")
  enableAutoFallback  Boolean  @default(true)
  responseDelay       Int      @default(2)
  autoResponseEnabled Boolean  @default(true)
  smartWaitingEnabled Boolean  @default(true)
  maxTokens           Int      @default(200)
  temperature         Float    @default(0.7)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("bot_settings")
}

model TrainingData {
  id             String       @id @default(cuid())
  userId         String
  conversationId String
  userMessage    String
  botResponse    String
  context        Json?
  productId      String?
  productName    String?
  category       String?
  qualityScore   Int?
  wasSuccessful  Boolean?
  userFeedback   String?
  createdAt      DateTime     @default(now())
  evaluatedAt    DateTime?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, qualityScore])
  @@index([category, qualityScore])
  @@index([createdAt])
  @@map("training_data")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  status               SubscriptionStatus @default(TRIAL)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  trialStart           DateTime?
  trialEnd             DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model WhatsAppConnection {
  id                 String           @id @default(cuid())
  userId             String           @unique
  phoneNumber        String           @unique
  status             ConnectionStatus @default(DISCONNECTED)
  qrCode             String?
  qrExpiresAt        DateTime?
  sessionId          String?
  lastConnectedAt    DateTime?
  lastMessageAt      DateTime?
  isConnected        Boolean          @default(false)
  webhookUrl         String?
  webhookSecret      String?
  accessToken        String?
  refreshToken       String?
  tokenExpiresAt     DateTime?
  connectionAttempts Int              @default(0)
  lastError          String?
  lastErrorAt        DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("whatsapp_connections")
}

model SubscriptionPlan {
  id            String       @id @default(cuid())
  name          String
  description   String
  price         Float
  currency      String       @default("USD")
  interval      PlanInterval
  intervalCount Int          @default(1)
  stripePriceId String?      @unique
  features      String
  isActive      Boolean      @default(true)
  sortOrder     Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@map("subscription_plans")
}

model Payment {
  id                 String              @id @default(cuid())
  userId             String
  subscriptionId     String?
  stripePaymentId    String?             @unique
  amount             Float
  currency           String              @default("USD")
  status             PaymentStatus       @default(PENDING)
  paymentMethod      String?
  description        String?
  metadata           String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  notificationTokens NotificationToken[]
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model PaymentConfig {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  mercadoPagoEnabled     Boolean  @default(false)
  mercadoPagoPublicKey   String?
  mercadoPagoAccessToken String?
  paypalEnabled          Boolean  @default(false)
  paypalClientId         String?
  paypalClientSecret     String?
  bankTransferEnabled    Boolean  @default(true)
  bankName               String?  @default("Bancolombia")
  bankAccountNumber      String?
  bankAccountType        String?  @default("Ahorros")
  bankAccountHolder      String?
  nequiEnabled           Boolean  @default(true)
  nequiPhone             String?  @default("3136174267")
  daviplataEnabled       Boolean  @default(true)
  daviplataPhone         String?  @default("3136174267")
  contactPhone           String?  @default("+57 304 274 8687")
  contactEmail           String?  @default("deinermen25@gmail.com")
  contactAddress         String?  @default("Centro Comercial El Diamante 2, San Nicolás, Cali")
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payment_configs")
}

model UsageMetric {
  id         String     @id @default(cuid())
  userId     String
  metricType MetricType
  value      Int
  period     String
  createdAt  DateTime   @default(now())
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, metricType, period])
  @@map("usage_metrics")
}

model MessageQueue {
  id          String      @id @default(cuid())
  phoneNumber String
  message     String
  type        String      @default("text")
  metadata    String?
  status      QueueStatus @default(PENDING)
  attempts    Int         @default(0)
  sentAt      DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("message_queue")
}

model LandingPage {
  id              Int      @id @default(autoincrement())
  productId       String
  template        String   @default("default")
  variant         String?
  heroImage       String?
  headline        String?
  subheadline     String?
  ctaText         String?
  ctaColor        String?
  benefits        String?
  features        String?
  urgencyMessage  String?
  guarantee       String?
  metaTitle       String?
  metaDescription String?
  ogImage         String?
  views           Int      @default(0)
  clicks          Int      @default(0)
  conversions     Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, variant])
  @@index([productId])
  @@map("landing_pages")
}

model PaymentIntegration {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  hotmartEnabled         Boolean  @default(false)
  hotmartApiKey          String?
  hotmartProductId       String?
  hotmartCheckoutUrl     String?
  hotmartEmail           String?
  mercadopagoEnabled     Boolean  @default(false)
  mercadopagoAccessToken String?
  mercadopagoPublicKey   String?
  mercadopagoEmail       String?
  paypalEnabled          Boolean  @default(false)
  paypalClientId         String?
  paypalClientSecret     String?
  paypalEmail            String?
  paypalMode             String?  @default("sandbox")
  stripeEnabled          Boolean  @default(false)
  stripeSecretKey        String?
  stripePublishableKey   String?
  stripeWebhookSecret    String?
  nequiEnabled           Boolean  @default(false)
  nequiPhone             String?
  nequiName              String?
  daviplataEnabled       Boolean  @default(false)
  daviplataPhone         String?
  daviplataName          String?
  bankTransferEnabled    Boolean  @default(false)
  bankName               String?
  bankAccountNumber      String?
  bankAccountType        String?
  bankAccountHolder      String?
  bankIdNumber           String?
  defaultCurrency        String?  @default("COP")
  autoGenerateLinks      Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Order {
  id              String   @id @default(cuid())
  userId          String?
  productId       String?
  quantity        Int      @default(1)
  customerName    String
  customerEmail   String?
  customerPhone   String
  customerAddress String?
  customerCity    String?
  shippingAddress String?
  notes           String?
  items           String?
  total           Float
  paymentMethod   String
  status          String   @default("pending")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([productId])
  @@index([status])
  @@map("orders")
}

model StoreSettings {
  id              String    @id @default(cuid())
  userId          String    @unique
  storeSlug       String    @unique
  customDomain    String?   @unique
  storeName       String    @default("Mi Tienda")
  storeSlogan     String?
  description     String?
  logo            String?
  logoSquare      String?
  favicon         String?
  bannerImage     String?
  primaryColor    String    @default("#10b981")
  secondaryColor  String    @default("#3b82f6")
  accentColor     String    @default("#f59e0b")
  layoutTemplate  String    @default("smartjoys")
  backgroundColor String    @default("#ffffff")
  textColor       String    @default("#1f2937")
  email           String?
  phone           String?
  whatsapp        String?
  address         String?
  city            String?
  country         String?   @default("Colombia")
  facebook        String?
  instagram       String?
  twitter         String?
  tiktok          String?
  youtube         String?
  linkedin        String?
  metaTitle       String?
  metaDescription String?
  keywords        String?
  ogImage         String?
  currency        String    @default("COP")
  language        String    @default("es")
  timezone        String    @default("America/Bogota")
  isPublic        Boolean   @default(true)
  isActive        Boolean   @default(true)
  termsUrl        String?
  privacyUrl      String?
  returnPolicy    String?
  shippingPolicy  String?
  viewCount       Int       @default(0)
  lastViewAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([storeSlug])
  @@index([isPublic, isActive])
}

model Appointment {
  id              String            @id @default(cuid())
  userId          String
  customerPhone   String
  customerName    String?
  conversationId  String?
  status          AppointmentStatus @default(PENDING_ADMIN_APPROVAL)
  requestedDate   DateTime?
  requestedTime   String?
  confirmedDate   DateTime?
  confirmedTime   String?
  adminResponse   String?
  customerMessage String?
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  conversation    Conversation?     @relation(fields: [conversationId], references: [id])
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("appointments")
}

model SalesFlowConfig {
  id                   String       @id @default(cuid())
  userId               String       @unique
  businessType         BusinessType @default(ECOMMERCE)
  dropshippingEnabled  Boolean      @default(false)
  deliveryDays         String?      @default("4-5 días hábiles")
  paymentOnDelivery    Boolean      @default(true)
  hasPhysicalStore     Boolean      @default(false)
  storeAddress         String?
  storeHours           String?
  allowPickup          Boolean      @default(false)
  requiresAppointment  Boolean      @default(false)
  appointmentDuration  Int?         @default(60)
  advanceBookingDays   Int?         @default(7)
  consultationEnabled  Boolean      @default(false)
  consultationPrice    Float?
  consultationDuration Int?         @default(30)
  welcomeMessage       String?
  priceMessage         String?
  deliveryMessage      String?
  confirmationMessage  String?
  requireName          Boolean      @default(true)
  requirePhone         Boolean      @default(true)
  requireEmail         Boolean      @default(false)
  requireAddress       Boolean      @default(true)
  requireCity          Boolean      @default(true)
  requireNotes         Boolean      @default(false)
  showColors           Boolean      @default(true)
  showSizes            Boolean      @default(false)
  showVariants         Boolean      @default(false)
  facebookEnabled      Boolean      @default(false)
  instagramEnabled     Boolean      @default(false)
  detectSocialMedia    Boolean      @default(true)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  user                 User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sales_flow_configs")
}

model ConversationKnowledge {
  id          String   @id @default(cuid())
  userQuery   String
  botResponse String
  productId   String?
  productName String?
  context     String   @default("general")
  confidence  Float    @default(0.8)
  usageCount  Int      @default(1)
  successRate Float    @default(1.0)
  createdAt   DateTime @default(now())
  lastUsedAt  DateTime @default(now())

  @@index([userQuery])
  @@index([productId])
  @@index([successRate])
  @@map("conversation_knowledge")
}

model ConversationPattern {
  id               String   @id @default(cuid())
  pattern          String   @unique
  queryType        String
  keywords         String
  responseTemplate String
  confidence       Float    @default(0.8)
  usageCount       Int      @default(1)
  successRate      Float    @default(1.0)
  createdAt        DateTime @default(now())
  lastUsedAt       DateTime @default(now())

  @@index([queryType])
  @@index([successRate])
  @@map("conversation_patterns")
}

model NotificationToken {
  id           String                @id @default(cuid())
  token        String                @unique
  type         NotificationTokenType
  purpose      String
  userId       String?
  paymentId    String?
  metadata     Json?
  status       TokenStatus           @default(PENDING)
  expiresAt    DateTime
  usedAt       DateTime?
  viewCount    Int                   @default(0)
  lastViewedAt DateTime?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  payment      Payment?              @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  user         User?                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId, type])
  @@index([paymentId])
  @@index([expiresAt])
  @@index([status])
  @@map("notification_tokens")
}

model BusinessSettings {
  id                  String    @id @default(cuid())
  userId              String    @unique
  detectedType        String    @default("UNKNOWN")
  detectedSubType     String?
  confidence          Float     @default(0.0)
  manualType          String?
  businessName        String?
  businessDescription String?
  tone                String    @default("friendly")
  customGreeting      String?
  customFarewell      String?
  enableBooking       Boolean   @default(false)
  enableCart          Boolean   @default(true)
  enableDelivery      Boolean   @default(true)
  enableLocation      Boolean   @default(false)
  serviceAreas        String?
  workingHours        String?
  lastDetectedAt      DateTime?
  itemsAnalyzed       Int       @default(0)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("business_settings")
}

model Category {
  id               String     @id @default(cuid())
  userId           String
  name             String
  slug             String
  description      String?
  parentId         String?
  icon             String?
  order            Int        @default(0)
  itemType         String     @default("MIXED")
  flowType         String?
  requiresBooking  Boolean    @default(false)
  requiresLocation Boolean    @default(false)
  keywords         String?
  itemCount        Int        @default(0)
  isAutoGenerated  Boolean    @default(true)
  generatedBy      String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  parent           Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children         Category[] @relation("CategoryHierarchy")
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
  @@index([userId])
  @@index([itemType])
  @@map("categories")
}

model PersistentMemory {
  conversationKey        String   @id
  userId                 String
  chatId                 String
  userName               String?
  currentProduct         String?
  productHistory         String   @default("[]")
  conversationStage      String   @default("greeting")
  messageCount           Int      @default(0)
  lastInteraction        String
  intentions             String   @default("[]")
  preferences            String   @default("{}")
  budget                 String?
  objections             String   @default("[]")
  photoSent              Boolean  @default(false)
  paymentIntent          Boolean  @default(false)
  preferredPaymentMethod String?
  lastUpdated            DateTime @default(now())

  @@index([userId])
  @@index([lastUpdated])
  @@map("persistent_memory")
}

enum UserRole {
  ADMIN
  USER
}

enum MembershipType {
  FREE
  TRIAL
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum ProductType {
  PHYSICAL
  DIGITAL
  SERVICE
}

enum ProductStatus {
  AVAILABLE
  OUT_OF_STOCK
  DISCONTINUED
}

enum ConversationStatus {
  ACTIVE
  CLOSED
  ARCHIVED
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  DOCUMENT
}

enum MessageDirection {
  INCOMING
  OUTGOING
}

enum PromptType {
  WELCOME
  PRODUCT_INFO
  PRICING
  SUPPORT
  CLOSING
  CUSTOM
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
}

enum ConnectionStatus {
  DISCONNECTED
  CONNECTING
  CONNECTED
  ERROR
  QR_PENDING
  QR_EXPIRED
}

enum PlanInterval {
  DAY
  WEEK
  MONTH
  YEAR
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELED
}

enum MetricType {
  MESSAGES_SENT
  MESSAGES_RECEIVED
  CONVERSATIONS
  API_CALLS
  STORAGE_USED
}

enum QueueStatus {
  PENDING
  SENT
  FAILED
}

enum AppointmentStatus {
  PENDING_ADMIN_APPROVAL
  ADMIN_RESPONDED
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum BusinessType {
  ECOMMERCE
  DROPSHIPPING
  PHYSICAL_STORE
  SERVICES
  APPOINTMENTS
  DIGITAL_PRODUCTS
  HYBRID
}

enum NotificationTokenType {
  PAYMENT_CONFIRMATION
  PAYMENT_REMINDER
  PAYMENT_INVOICE
  PAYMENT_STATUS
  ORDER_TRACKING
  DELIVERY_NOTIFICATION
  APPOINTMENT_CONFIRMATION
  APPOINTMENT_REMINDER
  ACCOUNT_VERIFICATION
  EMAIL_CHANGE
  TEMPORARY_ACCESS
  CUSTOM
}

enum TokenStatus {
  PENDING
  USED
  EXPIRED
  CANCELLED
}
