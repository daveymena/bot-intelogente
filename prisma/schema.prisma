// Smart Sales Bot Pro - Enhanced Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users and Authentication
model User {
  id                    String            @id @default(cuid())
  email                 String            @unique
  name                  String?
  phone                 String?
  password              String            // Hashed password
  role                  UserRole          @default(USER)
  membershipType        MembershipType    @default(FREE)
  membershipEnds        DateTime?
  trialEnds             DateTime?         // 7-day trial period
  isActive              Boolean           @default(true)
  isEmailVerified       Boolean           @default(false)
  emailVerificationToken String?
  isPhoneVerified       Boolean           @default(false)
  phoneVerificationCode String?
  phoneVerificationExpires DateTime?
  passwordResetToken    String?
  passwordResetExpires  DateTime?
  apiKey                String?           @unique
  whatsappNumber        String?
  businessName          String?
  businessAddress       String?           // Direcci√≥n f√≠sica del negocio
  businessPhone         String?           // Tel√©fono de contacto del negocio
  businessHours         String?           // Horario de atenci√≥n (JSON)
  businessDescription   String?           // Descripci√≥n del negocio
  adminNotificationPhone String?          @default("3005560186") // Tel√©fono para notificaciones
  lastLoginAt           DateTime?
  stripeCustomerId      String?           @unique
  
  // Subscription fields (for SaaS multi-tenant)
  subscriptionPlan      String?           @default("free") // free, basic, pro, enterprise
  subscriptionStatus    String?           @default("trial") // trial, active, expired, cancelled
  subscriptionExpiresAt DateTime?
  
  // Configuraciones del Dashboard (JSON)
  paymentMethods        String?           // JSON: MercadoPago, PayPal, Nequi, Daviplata, Bank
  businessInfo          String?           // JSON: Informaci√≥n del negocio
  notificationSettings  String?           // JSON: Configuraci√≥n de notificaciones
  
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  // Relations
  conversations         Conversation[]
  products              Product[]
  settings              BotSettings?
  aiPrompts             AIPrompt[]
  subscriptions         Subscription[]
  sessions              Session[]
  whatsappConnection    WhatsAppConnection?
  payments              Payment[]
  usageMetrics          UsageMetric[]
  paymentConfig         PaymentConfig?
  trainingData          TrainingData[]
  paymentIntegration    PaymentIntegration?
  storeSettings         StoreSettings?
  appointments          Appointment[]
  salesFlowConfig       SalesFlowConfig?
  
  notificationTokens    NotificationToken[]
  
  @@map("users")
}

// Products Management
model Product {
  id            String      @id @default(cuid())
  name          String
  description   String?
  price         Float
  currency      String      @default("COP")
  category      ProductType
  customCategory String?    // Categor√≠a personalizada creada por el usuario
  store         String?     // Tienda/Proveedor (ej: "MegaComputer", "Hotmart", "Propio")
  status        ProductStatus @default(AVAILABLE)
  images        String?     // JSON string array of image URLs
  tags          String?     // JSON string array of keywords for auto-response
  autoResponse  String?     // Predefined AI response
  stock         Int?        // null for digital products

  // üè∑Ô∏è Sistema de Tags Inteligentes (SaaS)
  smartTags     String?     // JSON array of smart tags with metadata
  tagCategory   String?     // Categor√≠a principal detectada autom√°ticamente
  searchPriority Int        @default(5) // Prioridad de b√∫squeda (1-10)
  autoTagged    Boolean     @default(false) // Si fue etiquetado autom√°ticamente
  
  // ü§ñ NUEVO: Sistema de Categorizaci√≥n Inteligente
  mainCategory     String?        // "Tecnolog√≠a", "Cursos", "Ropa", etc.
  productTags      String? // ["port√°til", "gaming", "estudio"]
  isAccessory      Boolean        @default(false) // Si es accesorio o producto principal
  parentCategory   String?        // Para accesorios: "Laptops", "Smartphones", etc.
  
  // Metadatos de categorizaci√≥n
  categorizedAt    DateTime?      // Cu√°ndo fue categorizado
  categorizedBy    String?        // "AI" o "Manual"
  categorizationConfidence Float? // Confianza de la IA (0-100)
  
  // Links de Pago Manuales (Configurables por producto)
  paymentLinkMercadoPago String?
  paymentLinkPayPal      String?
  paymentLinkCustom      String?  // Cualquier otro link (Hotmart, etc.)
  
  // Link de Entrega (Google Drive, etc.) para productos digitales
  deliveryLink           String?  // Link de acceso al contenido despu√©s del pago
  
  // Landing Page Content (JSON generado con IA)
  landingPageContent     String?  // JSON con headline, subheadline, benefits, cta, etc.
  
  userId        String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations Conversation[]
  landingPages  LandingPage[]
  
  @@index([category, mainCategory])
  @@index([store])
  @@map("products")
}


// Conversations and Messages
model Conversation {
  id            String           @id @default(cuid())
  customerPhone String
  customerName  String?
  status        ConversationStatus @default(ACTIVE)
  lastMessageAt DateTime         @default(now())
  userId        String
  productId     String?
  productName   String?          // Nombre del producto en contexto
  
  // üö® Escalamiento Inteligente
  needsHumanAttention Boolean      @default(false)
  escalationReason    String?      // Raz√≥n del escalamiento
  escalationCategory  String?      // Categor√≠a: complaint, complex_query, payment_issue, etc.
  escalatedAt         DateTime?    // Cu√°ndo se escal√≥
  resolvedAt          DateTime?    // Cu√°ndo se resolvi√≥
  
  // Relations
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  product       Product?         @relation(fields: [productId], references: [id])
  messages      Message[]
  appointments  Appointment[]
  trainingData  TrainingData[]
  
  @@index([needsHumanAttention])
  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  content        String
  type           MessageType  @default(TEXT)
  direction      MessageDirection // INCOMING or OUTGOING
  aiGenerated    Boolean      @default(false)
  confidence     Float?       // AI confidence score
  conversationId String
  createdAt      DateTime     @default(now())

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@map("messages")
}

// AI Prompts Management
model AIPrompt {
  id          String     @id @default(cuid())
  name        String
  prompt      String
  type        PromptType
  isActive    Boolean    @default(true)
  userId      String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("ai_prompts")
}

// Bot Configuration
model BotSettings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  businessName          String   @default("Tecnovariedades D&S")
  businessPhone         String
  
  // üìù Informaci√≥n del Negocio (para respuestas directas)
  businessHours         String?  // Horarios de atenci√≥n
  businessAddress       String?  // Direcci√≥n completa
  whatsappNumber        String?  // N√∫mero de WhatsApp
  shippingInfo          String?  // Informaci√≥n de env√≠os
  warrantyInfo          String?  // Pol√≠tica de garant√≠a
  
  botPersonality        String?  // Custom bot personality prompt
  // API Keys de Proveedores de IA
  groqApiKey           String?
  openaiApiKey         String?
  claudeApiKey         String?
  geminiApiKey         String?
  mistralApiKey        String?
  anthropicApiKey      String?  // Claude alternativo
  openrouterApiKey     String?  // OpenRouter (acceso a m√∫ltiples modelos)
  ollamaBaseUrl        String?  // Para IA local con Ollama
  ollamaModel          String?  @default("llama3.1")
  
  // Configuraci√≥n de Prioridad de IA
  preferredAiProvider  String   @default("groq")  // Proveedor preferido
  aiProviderPriority   String   @default("[\"groq\",\"openai\",\"gemini\",\"claude\",\"mistral\"]") // JSON array
  enableAutoFallback   Boolean  @default(true)    // Fallback autom√°tico si falla
  
  // Configuraci√≥n de Respuestas
  responseDelay        Int      @default(2) // seconds
  autoResponseEnabled  Boolean  @default(true)
  smartWaitingEnabled  Boolean  @default(true)
  maxTokens            Int      @default(200) // Reducido para respuestas cortas
  temperature          Float    @default(0.7)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("bot_settings")
}

// Training Data for ML
model TrainingData {
  id                String        @id @default(cuid())
  userId            String
  conversationId    String
  
  // Datos de entrada
  userMessage       String
  botResponse       String
  context           Json?         // Historial, producto mencionado, etc.
  
  // Metadatos
  productId         String?
  productName       String?
  category          String?       // "producto", "pago", "soporte", etc.
  
  // Evaluaci√≥n
  qualityScore      Int?          // 1-5
  wasSuccessful     Boolean?      // ¬øHubo venta o respuesta positiva?
  userFeedback      String?       // Respuesta del cliente despu√©s
  
  // Timestamps
  createdAt         DateTime      @default(now())
  evaluatedAt       DateTime?
  
  // Relaciones
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation      Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@map("training_data")
  @@index([userId, qualityScore])
  @@index([category, qualityScore])
  @@index([createdAt])
}

// User Sessions
model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// Subscriptions
model Subscription {
  id                String            @id @default(cuid())
  userId            String            @unique
  stripeSubscriptionId String?        @unique
  stripePriceId     String?
  status            SubscriptionStatus @default(TRIAL)
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd Boolean           @default(false)
  trialStart        DateTime?
  trialEnd          DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// WhatsApp Connection
model WhatsAppConnection {
  id                String              @id @default(cuid())
  userId            String              @unique
  phoneNumber       String              @unique
  status            ConnectionStatus    @default(DISCONNECTED)
  qrCode            String?             // Base64 encoded QR
  qrExpiresAt       DateTime?
  sessionId         String?             // WhatsApp session ID
  lastConnectedAt   DateTime?
  lastMessageAt     DateTime?
  isConnected       Boolean             @default(false)
  webhookUrl        String?
  webhookSecret     String?
  accessToken       String?             // OAuth token
  refreshToken      String?             // For token refresh
  tokenExpiresAt    DateTime?
  connectionAttempts Int                @default(0)
  lastError         String?
  lastErrorAt       DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("whatsapp_connections")
}

// Subscription Plans
model SubscriptionPlan {
  id                String              @id @default(cuid())
  name              String
  description       String
  price             Float
  currency          String              @default("USD")
  interval          PlanInterval
  intervalCount     Int                 @default(1)
  stripePriceId     String?             @unique
  features          String              // JSON array of features
  isActive          Boolean             @default(true)
  sortOrder         Int                 @default(0)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@map("subscription_plans")
}

// Payment History
model Payment {
  id                String              @id @default(cuid())
  userId            String
  subscriptionId    String?
  stripePaymentId   String?             @unique
  amount            Float
  currency          String              @default("USD")
  status            PaymentStatus        @default(PENDING)
  paymentMethod     String?
  description       String?
  metadata          String?             // JSON metadata
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  notificationTokens NotificationToken[]
  
  @@map("payments")
}

// Payment Configuration (Configurable desde Dashboard)
model PaymentConfig {
  id                    String   @id @default(cuid())
  userId                String   @unique
  
  // MercadoPago
  mercadoPagoEnabled    Boolean  @default(false)
  mercadoPagoPublicKey  String?
  mercadoPagoAccessToken String?
  
  // PayPal
  paypalEnabled         Boolean  @default(false)
  paypalClientId        String?
  paypalClientSecret    String?
  
  // Transferencias Bancarias
  bankTransferEnabled   Boolean  @default(true)
  bankName              String?  @default("Bancolombia")
  bankAccountNumber     String?
  bankAccountType       String?  @default("Ahorros")
  bankAccountHolder     String?
  
  // Nequi
  nequiEnabled          Boolean  @default(true)
  nequiPhone            String?  @default("3136174267")
  
  // Daviplata
  daviplataEnabled      Boolean  @default(true)
  daviplataPhone        String?  @default("3136174267")
  
  // Informaci√≥n de Contacto
  contactPhone          String?  @default("+57 304 274 8687")
  contactEmail          String?  @default("deinermen25@gmail.com")
  contactAddress        String?  @default("Centro Comercial El Diamante 2, San Nicol√°s, Cali")
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("payment_configs")
}

// Usage Metrics
model UsageMetric {
  id                String              @id @default(cuid())
  userId            String
  metricType        MetricType
  value             Int
  period            String              // e.g., "2024-01", "2024-01-15"
  createdAt         DateTime            @default(now())

  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, metricType, period])
  @@map("usage_metrics")
}

// Message Queue (para reconexi√≥n autom√°tica)
model MessageQueue {
  id            String              @id @default(cuid())
  phoneNumber   String
  message       String
  type          String              @default("text") // text, image, audio
  metadata      String?             // JSON metadata
  status        QueueStatus         @default(PENDING)
  attempts      Int                 @default(0)
  sentAt        DateTime?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@map("message_queue")
}

// Landing Pages - Configuraci√≥n personalizada por producto
model LandingPage {
  id                Int       @id @default(autoincrement())
  productId         String
  product           Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Configuraci√≥n de plantilla
  template          String    @default("default") // 'default', 'physical', 'digital', 'dropshipping'
  variant           String?   // 'a', 'b', 'c' para A/B testing
  
  // Personalizaci√≥n de contenido
  heroImage         String?
  headline          String?
  subheadline       String?
  ctaText           String?
  ctaColor          String?
  benefits          String?   // JSON array
  features          String?   // JSON array
  urgencyMessage    String?
  guarantee         String?
  
  // SEO y Meta Tags
  metaTitle         String?
  metaDescription   String?
  ogImage           String?
  
  // Tracking y Analytics
  views             Int       @default(0)
  clicks            Int       @default(0)
  conversions       Int       @default(0)
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@unique([productId, variant])
  @@map("landing_pages")
  @@index([productId])
}

// Enums
enum UserRole {
  ADMIN
  USER
}

enum MembershipType {
  FREE
  TRIAL
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum ProductType {
  PHYSICAL
  DIGITAL
  SERVICE
}

enum ProductStatus {
  AVAILABLE
  OUT_OF_STOCK
  DISCONTINUED
}

enum ConversationStatus {
  ACTIVE
  CLOSED
  ARCHIVED
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  DOCUMENT
}

enum MessageDirection {
  INCOMING
  OUTGOING
}

enum PromptType {
  WELCOME
  PRODUCT_INFO
  PRICING
  SUPPORT
  CLOSING
  CUSTOM
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
}

enum ConnectionStatus {
  DISCONNECTED
  CONNECTING
  CONNECTED
  ERROR
  QR_PENDING
  QR_EXPIRED
}

enum PlanInterval {
  DAY
  WEEK
  MONTH
  YEAR
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELED
}

enum MetricType {
  MESSAGES_SENT
  MESSAGES_RECEIVED
  CONVERSATIONS
  API_CALLS
  STORAGE_USED
}

enum QueueStatus {
  PENDING
  SENT
  FAILED
}


// Payment Integrations Configuration
model PaymentIntegration {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Hotmart
  hotmartEnabled      Boolean  @default(false)
  hotmartApiKey       String?
  hotmartProductId    String?
  hotmartCheckoutUrl  String?
  hotmartEmail        String?
  
  // MercadoPago
  mercadopagoEnabled      Boolean  @default(false)
  mercadopagoAccessToken  String?
  mercadopagoPublicKey    String?
  mercadopagoEmail        String?
  
  // PayPal
  paypalEnabled       Boolean  @default(false)
  paypalClientId      String?
  paypalClientSecret  String?
  paypalEmail         String?
  paypalMode          String?  @default("sandbox")
  
  // Stripe
  stripeEnabled          Boolean  @default(false)
  stripeSecretKey        String?
  stripePublishableKey   String?
  stripeWebhookSecret    String?
  
  // Nequi/Daviplata (Colombia)
  nequiEnabled        Boolean  @default(false)
  nequiPhone          String?
  nequiName           String?
  
  daviplataEnabled    Boolean  @default(false)
  daviplataPhone      String?
  daviplataName       String?
  
  // Transferencia Bancaria
  bankTransferEnabled Boolean  @default(false)
  bankName            String?
  bankAccountNumber   String?
  bankAccountType     String?
  bankAccountHolder   String?
  bankIdNumber        String?
  
  // Configuraci√≥n General
  defaultCurrency     String?  @default("COP")
  autoGenerateLinks   Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Orders - √ìrdenes de compra
model Order {
  id              String       @id @default(cuid())
  userId          String?      // ID del vendedor
  productId       String?      // ID del producto
  quantity        Int          @default(1)
  customerName    String
  customerEmail   String?
  customerPhone   String
  customerAddress String?
  customerCity    String?
  shippingAddress String?      // Direcci√≥n completa de env√≠o
  notes           String?
  items           String?      // JSON string de los productos (para pedidos m√∫ltiples)
  total           Float
  paymentMethod   String
  status          String       @default("pending") // pending, paid, completed, cancelled
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([userId])
  @@index([productId])
  @@index([status])
  @@map("orders")
}

// Store Settings - Configuraci√≥n de la tienda
model StoreSettings {
  id          String   @id @default(cuid())
  userId      String   @unique
  
  // URL √∫nica de la tienda
  storeSlug   String   @unique // URL amigable: /tienda/mi-tienda-tech
  customDomain String? @unique // Dominio personalizado opcional
  
  // Informaci√≥n b√°sica
  storeName   String   @default("Mi Tienda")
  storeSlogan String?
  description String?
  
  // Branding
  logo        String?  // URL del logo principal
  logoSquare  String?  // Logo cuadrado para favicon/redes
  favicon     String?  // Favicon personalizado
  bannerImage String?  // Banner/Hero de la tienda
  
  // Colores personalizados
  primaryColor String  @default("#10b981") // Color principal
  secondaryColor String @default("#3b82f6") // Color secundario
  accentColor String   @default("#f59e0b") // Color de acento
  backgroundColor String @default("#ffffff") // Fondo
  textColor   String   @default("#1f2937") // Texto principal
  
  // Contacto
  email       String?
  phone       String?
  whatsapp    String?
  address     String?
  city        String?
  country     String?  @default("Colombia")
  
  // Redes sociales
  facebook    String?
  instagram   String?
  twitter     String?
  tiktok      String?
  youtube     String?
  linkedin    String?
  
  // SEO
  metaTitle   String?
  metaDescription String?
  keywords    String?
  ogImage     String?  // Imagen para compartir en redes
  
  // Configuraci√≥n
  currency    String   @default("COP")
  language    String   @default("es")
  timezone    String   @default("America/Bogota")
  
  // Visibilidad
  isPublic    Boolean  @default(true) // Si la tienda es p√∫blica
  isActive    Boolean  @default(true) // Si la tienda est√° activa
  
  // Pol√≠ticas
  termsUrl    String?
  privacyUrl  String?
  returnPolicy String?
  shippingPolicy String?
  
  // Estad√≠sticas
  viewCount   Int      @default(0)
  lastViewAt  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([storeSlug])
  @@index([isPublic, isActive])
}

// Appointments / Citas
model Appointment {
  id                String              @id @default(cuid())
  userId            String
  customerPhone     String
  customerName      String?
  conversationId    String?
  status            AppointmentStatus   @default(PENDING_ADMIN_APPROVAL)
  requestedDate     DateTime?
  requestedTime     String?
  confirmedDate     DateTime?
  confirmedTime     String?
  adminResponse     String?
  customerMessage   String?
  notes             String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation      Conversation?       @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  @@map("appointments")
}

enum AppointmentStatus {
  PENDING_ADMIN_APPROVAL  // Cliente solicit√≥ cita, esperando respuesta del admin
  ADMIN_RESPONDED         // Admin respondi√≥ con disponibilidad
  CONFIRMED               // Cita confirmada
  CANCELLED               // Cita cancelada
  COMPLETED               // Cita completada
}

// Sales Flow Configuration - Configuraci√≥n de flujos de venta
model SalesFlowConfig {
  id                String              @id @default(cuid())
  userId            String              @unique
  
  // Tipo de negocio
  businessType      BusinessType        @default(ECOMMERCE)
  
  // Configuraci√≥n de dropshipping
  dropshippingEnabled Boolean           @default(false)
  deliveryDays      String?             @default("4-5 d√≠as h√°biles")
  paymentOnDelivery Boolean             @default(true)
  
  // Configuraci√≥n de tienda f√≠sica
  hasPhysicalStore  Boolean             @default(false)
  storeAddress      String?
  storeHours        String?             // JSON: { "monday": "9am-7pm", ... }
  allowPickup       Boolean             @default(false)
  
  // Configuraci√≥n de servicios
  requiresAppointment Boolean           @default(false)
  appointmentDuration Int?              @default(60) // minutos
  advanceBookingDays Int?               @default(7)
  
  // Configuraci√≥n de vendedor/consultor
  consultationEnabled Boolean           @default(false)
  consultationPrice Float?
  consultationDuration Int?             @default(30) // minutos
  
  // Mensajes personalizados
  welcomeMessage    String?
  priceMessage      String?
  deliveryMessage   String?
  confirmationMessage String?
  
  // Campos requeridos para captura de datos
  requireName       Boolean             @default(true)
  requirePhone      Boolean             @default(true)
  requireEmail      Boolean             @default(false)
  requireAddress    Boolean             @default(true)
  requireCity       Boolean             @default(true)
  requireNotes      Boolean             @default(false)
  
  // Opciones de productos
  showColors        Boolean             @default(true)
  showSizes         Boolean             @default(false)
  showVariants      Boolean             @default(false)
  
  // Integraci√≥n con redes sociales
  facebookEnabled   Boolean             @default(false)
  instagramEnabled  Boolean             @default(false)
  detectSocialMedia Boolean             @default(true)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sales_flow_configs")
}

// Enum para tipos de negocio
enum BusinessType {
  ECOMMERCE         // Tienda online con productos f√≠sicos
  DROPSHIPPING      // Dropshipping con env√≠o
  PHYSICAL_STORE    // Tienda f√≠sica
  SERVICES          // Servicios profesionales (vendedor, consultor)
  APPOINTMENTS      // Servicios con citas (cl√≠nica, peluquer√≠a, spa)
  DIGITAL_PRODUCTS  // Productos digitales (cursos, megapacks)
  HYBRID            // Combinaci√≥n de varios tipos
}


// üß† Base de Conocimiento Local - Sistema de Aprendizaje
model ConversationKnowledge {
  id            String   @id @default(cuid())
  userQuery     String   // Pregunta del usuario (normalizada)
  botResponse   String   // Respuesta del bot
  productId     String?  // ID del producto relacionado (opcional)
  productName   String?  // Nombre del producto
  context       String   @default("general") // Contexto de la conversaci√≥n
  confidence    Float    @default(0.8) // Confianza de la respuesta (0-1)
  usageCount    Int      @default(1) // Cu√°ntas veces se ha usado
  successRate   Float    @default(1.0) // Tasa de √©xito (0-1)
  createdAt     DateTime @default(now())
  lastUsedAt    DateTime @default(now())
  
  @@index([userQuery])
  @@index([productId])
  @@index([successRate])
  @@map("conversation_knowledge")
}

// üß† Patrones de Conversaci√≥n Aprendidos (para matching r√°pido)
model ConversationPattern {
  id              String   @id @default(cuid())
  pattern         String   @unique // Patr√≥n normalizado de la consulta
  queryType       String   // Tipo: price_inquiry, photo_request, etc.
  keywords        String   // Palabras clave separadas por comas
  responseTemplate String  // Template de respuesta
  confidence      Float    @default(0.8)
  usageCount      Int      @default(1)
  successRate     Float    @default(1.0)
  createdAt       DateTime @default(now())
  lastUsedAt      DateTime @default(now())
  
  @@index([queryType])
  @@index([successRate])
  @@map("conversation_patterns")
}

// üîî Sistema Universal de Notificaciones con Tokens
model NotificationToken {
  id            String              @id @default(cuid())
  token         String              @unique // Token hasheado (SHA-256)
  type          NotificationTokenType // Tipo de notificaci√≥n
  purpose       String              // Descripci√≥n del prop√≥sito
  
  // Relaciones
  userId        String?
  user          User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  paymentId     String?
  payment       Payment?            @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  
  // Datos adicionales (JSON flexible)
  metadata      Json?               // Datos espec√≠ficos del tipo de notificaci√≥n
  
  // Estado y expiraci√≥n
  status        TokenStatus         @default(PENDING)
  expiresAt     DateTime
  usedAt        DateTime?
  
  // Tracking
  viewCount     Int                 @default(0)
  lastViewedAt  DateTime?
  ipAddress     String?
  userAgent     String?
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  @@index([token])
  @@index([userId, type])
  @@index([paymentId])
  @@index([expiresAt])
  @@index([status])
  @@map("notification_tokens")
}

// Enum para tipos de tokens de notificaci√≥n
enum NotificationTokenType {
  PAYMENT_CONFIRMATION    // Confirmaci√≥n de pago recibido
  PAYMENT_REMINDER        // Recordatorio de pago pendiente
  PAYMENT_INVOICE         // Ver factura/recibo
  PAYMENT_STATUS          // Ver estado de pago
  ORDER_TRACKING          // Seguimiento de pedido
  DELIVERY_NOTIFICATION   // Notificaci√≥n de entrega
  APPOINTMENT_CONFIRMATION // Confirmaci√≥n de cita
  APPOINTMENT_REMINDER    // Recordatorio de cita
  ACCOUNT_VERIFICATION    // Verificaci√≥n de cuenta
  EMAIL_CHANGE            // Cambio de email
  TEMPORARY_ACCESS        // Acceso temporal
  CUSTOM                  // Personalizado
}

// Enum para estado de tokens
enum TokenStatus {
  PENDING     // Pendiente de uso
  USED        // Ya fue usado
  EXPIRED     // Expirado
  CANCELLED   // Cancelado
}

// üíæ Memoria Persistente entre Sesiones
model PersistentMemory {
  conversationKey String   @id // Formato: "userId:chatId"
  userId          String
  chatId          String
  userName        String?

  // Producto actual
  currentProduct  String?  // JSON stringified UnifiedMemory['currentProduct']

  // Historial de productos
  productHistory  String   @default("[]") // JSON stringified array

  // Estado de conversaci√≥n
  conversationStage String @default("greeting")
  messageCount    Int      @default(0)
  lastInteraction String   // ISO date string

  // Intenciones y contexto
  intentions      String   @default("[]") // JSON stringified array
  preferences     String   @default("{}") // JSON stringified object

  // Informaci√≥n financiera
  budget          String?  // JSON stringified budget object

  // Objeciones detectadas
  objections      String   @default("[]") // JSON stringified array

  // Flags operativos
  photoSent      Boolean  @default(false)
  paymentIntent  Boolean  @default(false)
  preferredPaymentMethod String?

  // Metadata
  lastUpdated    DateTime @default(now())

  @@map("persistent_memory")
  @@index([userId])
  @@index([lastUpdated])
}






