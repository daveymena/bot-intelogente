# ๐ค CUรNDO USA IA Y CUรNDO NO

## ๐ FLUJO COMPLETO DE DECISIรN

```
MENSAJE DEL CLIENTE
        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ PRIORIDAD 0: BOT LOCAL (< 100ms)                         โ
โ โ NO USA IA                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Detecta:                                                  โ
โ โข "Hola" โ Saludo                                        โ
โ โข "Gracias" โ Agradecimiento                             โ
โ โข "Adiรณs" โ Despedida                                    โ
โ โข "Ok" / "Listo" โ Confirmaciรณn                          โ
โ                                                           โ
โ Respuesta: INSTANTรNEA (respuestas pre-programadas)      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ (Si no detecta patrรณn simple)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ PRIORIDAD 1: RESPUESTAS DIRECTAS                         โ
โ โ NO USA IA                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Detecta:                                                  โ
โ โข "ยฟHorarios?" โ Info de BD                              โ
โ โข "ยฟUbicaciรณn?" โ Info de BD                             โ
โ โข "ยฟTelรฉfono?" โ Info de BD                              โ
โ                                                           โ
โ Respuesta: Desde base de datos (sin IA)                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ (Si no es respuesta directa)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ PRIORIDAD 2: DETECCIรN DE PAGO                           โ
โ โ NO USA IA (solo detecciรณn de patrones)                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Detecta:                                                  โ
โ โข "Quiero pagar"                                         โ
โ โข "Link de pago"                                         โ
โ โข "Cรณmo pago"                                            โ
โ โข "Mercado pago"                                         โ
โ                                                           โ
โ Acciรณn:                                                   โ
โ 1. Busca producto en MEMORIA PROFESIONAL                 โ
โ 2. Si encuentra โ Genera enlaces de pago                 โ
โ 3. Si NO encuentra โ Pregunta quรฉ producto               โ
โ                                                           โ
โ Respuesta: AUTOMรTICA (sin IA)                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ (Si no es solicitud de pago)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ PRIORIDAD 3: FLUJO DE CALIFICACIรN                       โ
โ โ NO USA IA (lรณgica programada)                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Detecta:                                                  โ
โ โข "Busco laptop" โ ยฟPara quรฉ la necesitas?              โ
โ โข "Quiero moto" โ ยฟPara ciudad o carretera?             โ
โ                                                           โ
โ Respuesta: Preguntas pre-programadas                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ (Si no es calificaciรณn)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ PRIORIDAD 4: BรSQUEDA DE PRODUCTOS                       โ
โ โ USA IA (Groq) - AQUร EMPIEZA A USAR IA               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Detecta:                                                  โ
โ โข "Curso de piano"                                       โ
โ โข "Laptop para diseรฑo"                                   โ
โ โข "Megapack de programaciรณn"                             โ
โ                                                           โ
โ Proceso:                                                  โ
โ 1. ๐ Busca producto en BD (sin IA)                     โ
โ 2. ๐ค USA GROQ para generar respuesta natural           โ
โ    - Explica el producto                                 โ
โ    - Destaca beneficios                                  โ
โ    - Menciona precio                                     โ
โ    - Invita a la acciรณn                                  โ
โ                                                           โ
โ Modelo: llama-3.3-70b-versatile                          โ
โ Tiempo: 2-4 segundos                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ (Si no encuentra producto especรญfico)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ PRIORIDAD 5: CONVERSACIรN GENERAL                        โ
โ โ USA IA (Groq) - CONVERSACIรN LIBRE                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Ejemplos:                                                 โ
โ โข "ยฟQuรฉ productos tienen?"                               โ
โ โข "Necesito algo para trabajar desde casa"               โ
โ โข "ยฟTienen garantรญa?"                                    โ
โ โข "ยฟHacen envรญos?"                                       โ
โ                                                           โ
โ Proceso:                                                  โ
โ 1. ๐ค USA GROQ con contexto completo                    โ
โ    - Historial de conversaciรณn (24h)                     โ
โ    - Productos disponibles                               โ
โ    - Personalidad configurada                            โ
โ    - Informaciรณn del negocio                             โ
โ                                                           โ
โ Modelo: llama-3.3-70b-versatile                          โ
โ Tiempo: 2-4 segundos                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ ESTADรSTICAS DE USO

### โ SIN IA (70% de mensajes)
- Saludos: "Hola", "Buenos dรญas" โ Bot Local
- Despedidas: "Adiรณs", "Chao" โ Bot Local
- Agradecimientos: "Gracias" โ Bot Local
- Confirmaciones: "Ok", "Listo" โ Bot Local
- Info bรกsica: Horarios, ubicaciรณn โ Respuestas directas
- Solicitudes de pago: "Quiero pagar" โ Detecciรณn automรกtica

### โ CON IA (30% de mensajes)
- Preguntas sobre productos especรญficos
- Conversaciones complejas
- Preguntas tรฉcnicas
- Comparaciones de productos
- Recomendaciones personalizadas

## ๐ฏ EJEMPLOS REALES

### Ejemplo 1: SIN IA (Bot Local)
```
Cliente: "Hola"
Bot: [Bot Local detecta saludo]
     [Responde en < 100ms]
     "ยกHola! ๐ Bienvenido a Tecnovariedades D&S..."
     
โ NO USA IA
โก Tiempo: < 100ms
```

### Ejemplo 2: SIN IA (Detecciรณn de Pago)
```
Cliente: "Quiero pagar por mercado pago"
Bot: [Detecta solicitud de pago]
     [Busca en memoria: Curso de Piano]
     [Genera enlaces automรกticamente]
     "๐ณ Perfecto! Aquรญ estรกn tus opciones de pago..."
     
โ NO USA IA
โก Tiempo: < 500ms
```

### Ejemplo 3: USA IA (Producto Especรญfico)
```
Cliente: "Estoy interesado en el curso de piano"
Bot: [Busca producto en BD: Curso Completo de Piano Online]
     [๐ค USA GROQ para generar respuesta]
     [Contexto: producto, precio, historial, personalidad]
     "ยกGenial! ๐น El Curso Completo de Piano Online es..."
     
โ USA IA (GROQ)
โฑ๏ธ Tiempo: 2-4 segundos
๐ Modelo: llama-3.3-70b-versatile
```

### Ejemplo 4: USA IA (Conversaciรณn Compleja)
```
Cliente: "ยฟQuรฉ laptop me recomiendas para diseรฑo grรกfico?"
Bot: [No hay producto especรญfico]
     [๐ค USA GROQ con contexto completo]
     [Analiza: necesidad, presupuesto, productos disponibles]
     "Para diseรฑo grรกfico te recomiendo..."
     
โ USA IA (GROQ)
โฑ๏ธ Tiempo: 2-4 segundos
๐ Modelo: llama-3.3-70b-versatile
```

## ๐ CรMO IDENTIFICAR EN LOS LOGS

### Sin IA:
```
[Baileys] โก BOT LOCAL respondiรณ (greeting) - Confianza: 95%
[Baileys] โ Respuesta local enviada en < 100ms
```

### Con IA:
```
[Baileys] ๐ค Bot local no detectรณ patrรณn, usando IA...
[AI] Generando respuesta para: "Estoy interesado en el curso de piano"
[AI] ๐ง Usando sistema de razonamiento avanzado (Ollama โ Groq)
[Groq] โก Modelo: llama-3.3-70b-versatile
[AI] โ Respuesta generada con: groq (llama-3.3-70b-versatile)
```

## ๐๏ธ CONFIGURACIรN DE IA

### Variables de Entorno (.env)
```bash
# IA Principal
GROQ_API_KEY=tu_api_key
GROQ_MODEL=llama-3.3-70b-versatile
GROQ_MAX_TOKENS=500

# Sistema de Razonamiento
AI_USE_REASONING=true  # Usa Ollama โ Groq (fallback)

# Fallback Multi-Provider
AI_FALLBACK_ENABLED=false  # Desactivado (solo Groq)
```

### Cuรกndo se Llama a Groq:
1. **Bรบsqueda de productos**: Cuando encuentra un producto y necesita explicarlo
2. **Conversaciรณn general**: Cuando no detecta patrรณn simple
3. **Preguntas complejas**: Comparaciones, recomendaciones, dudas tรฉcnicas

### Quรฉ Recibe Groq:
```typescript
{
  systemPrompt: `
    - Personalidad del bot (desde dashboard)
    - Informaciรณn del negocio
    - Productos disponibles
    - Reglas de respuesta
    - Contexto de memoria profesional
  `,
  conversationHistory: [
    // รltimos 5 mensajes (24h)
  ],
  userMessage: "Mensaje actual del cliente"
}
```

## ๐ก OPTIMIZACIรN

### Por quรฉ este diseรฑo:
1. **70% sin IA** = Respuestas instantรกneas + Ahorro de costos
2. **30% con IA** = Conversaciones naturales y complejas
3. **Memoria profesional** = Contexto entre mensajes sin llamar IA cada vez

### Ventajas:
- โก Respuestas rรกpidas para mensajes simples
- ๐ฐ Menor costo de API (solo usa IA cuando es necesario)
- ๐ฏ IA enfocada en conversaciones complejas
- ๐ง Memoria mantiene contexto sin re-procesar

## ๐ง CรMO AJUSTAR

### Para usar MรS IA:
Edita `src/lib/enhanced-local-bot.ts` y reduce los patrones detectados.

### Para usar MENOS IA:
Agrega mรกs patrones en `src/lib/enhanced-local-bot.ts` y `src/lib/direct-response-handler.ts`.

### Para cambiar modelo de IA:
```bash
# En .env
GROQ_MODEL=llama-3.1-8b-instant  # Mรกs rรกpido, menos preciso
GROQ_MODEL=llama-3.3-70b-versatile  # Mรกs lento, mรกs preciso (actual)
```

## ๐ RESUMEN VISUAL

```
100 mensajes recibidos
โ
โโ 70 mensajes โ BOT LOCAL / RESPUESTAS DIRECTAS (sin IA)
โ  โโ 40 saludos/despedidas/gracias
โ  โโ 20 solicitudes de pago
โ  โโ 10 info bรกsica (horarios, ubicaciรณn)
โ
โโ 30 mensajes โ GROQ IA
   โโ 20 preguntas sobre productos
   โโ 10 conversaciones complejas
```

## โ CONCLUSIรN

**El bot USA IA solo cuando es necesario:**
- โ NO para saludos, despedidas, agradecimientos
- โ NO para solicitudes de pago (usa memoria)
- โ NO para info bรกsica (usa BD)
- โ Sร para explicar productos
- โ Sร para conversaciones complejas
- โ Sร para recomendaciones personalizadas

**Esto hace que el bot sea:**
- โก Rรกpido (70% respuestas < 100ms)
- ๐ฐ Econรณmico (solo paga IA cuando vale la pena)
- ๐ฏ Efectivo (IA enfocada en ventas complejas)
