/**
 * üß™ TEST: Verificar que el bot mantiene contexto de producto
 * 
 * Simula una conversaci√≥n donde:
 * 1. Cliente pregunta por "curso de piano"
 * 2. Cliente dice "ver m√°s informaci√≥n" (sin mencionar piano)
 * 3. Bot debe recordar que hablaban del piano
 */

import { ProductIntelligenceService } from '../src/lib/product-intelligence-service'
import { ConversationContextService } from '../src/lib/conversation-context-service'
import { db } from '../src/lib/db'

async function testContextoProducto() {
    console.log('üß™ TEST: Contexto de Producto\n')

    const userId = 'cmhdldjwp0000kmn8m5208jmi'
    const customerPhone = '181656229036263@lid'
    const conversationKey = `${userId}:${customerPhone}`

    try {
        // PASO 1: Cliente pregunta por piano
        console.log('üìù PASO 1: Cliente pregunta "Tienes disponible el curso de piano?"')
        const mensaje1 = "Tienes disponible el curso de piano?"
        
        const producto1 = await ProductIntelligenceService.findProduct(mensaje1, userId)
        
        if (producto1) {
            console.log(`‚úÖ Producto encontrado: ${producto1.name}`)
            ConversationContextService.setProductContext(conversationKey, producto1.id, producto1.name)
            console.log(`üíæ Guardado en memoria\n`)
        } else {
            console.log(`‚ùå No se encontr√≥ producto\n`)
        }

        // PASO 2: Cliente dice "ver m√°s informaci√≥n" (sin mencionar piano)
        console.log('üìù PASO 2: Cliente dice "Si deseo ver m√°s informaci√≥n"')
        const mensaje2 = "Si deseo ver m√°s informaci√≥n"
        
        const producto2 = await ProductIntelligenceService.findProduct(mensaje2, userId)
        
        if (producto2) {
            console.log(`‚ùå ERROR: Encontr√≥ producto nuevo: ${producto2.name}`)
            console.log(`   Deber√≠a usar el contexto de memoria en vez de buscar nuevo producto\n`)
        } else {
            console.log(`‚úÖ No encontr√≥ producto nuevo (correcto)`)
            
            // Verificar memoria
            const context = ConversationContextService.getProductContext(conversationKey)
            if (context) {
                console.log(`‚úÖ Memoria activa: ${context.lastProductName}`)
                
                // Obtener producto de memoria
                const productoMemoria = await db.product.findUnique({
                    where: { id: context.lastProductId }
                })
                
                if (productoMemoria) {
                    console.log(`‚úÖ Producto recuperado de memoria: ${productoMemoria.name}`)
                    console.log(`\nüéâ TEST EXITOSO: El bot mantiene el contexto correctamente`)
                }
            } else {
                console.log(`‚ùå ERROR: No hay contexto en memoria`)
            }
        }

        // PASO 3: Verificar que palabras clave se extraen correctamente
        console.log('\nüìù PASO 3: Verificar extracci√≥n de palabras clave')
        
        const testCases = [
            { mensaje: "Tienes disponible el curso de piano?", esperado: ['curso', 'piano'] },
            { mensaje: "Si deseo ver m√°s informaci√≥n", esperado: [] },
            { mensaje: "Quiero comprar la MacBook", esperado: ['comprar', 'macbook'] },
            { mensaje: "Ver fotos", esperado: [] },
            { mensaje: "Cu√°nto cuesta la moto Pulsar?", esperado: ['moto', 'pulsar'] }
        ]

        for (const test of testCases) {
            // Acceder al m√©todo privado usando reflexi√≥n
            const keywords = (ProductIntelligenceService as any).extractKeywords(test.mensaje)
            const match = JSON.stringify(keywords.sort()) === JSON.stringify(test.esperado.sort())
            
            console.log(`${match ? '‚úÖ' : '‚ùå'} "${test.mensaje}"`)
            console.log(`   Esperado: [${test.esperado.join(', ')}]`)
            console.log(`   Obtenido: [${keywords.join(', ')}]`)
        }

        console.log('\n‚úÖ Test completado')

    } catch (error) {
        console.error('‚ùå Error en test:', error)
    } finally {
        await db.$disconnect()
    }
}

testContextoProducto()
