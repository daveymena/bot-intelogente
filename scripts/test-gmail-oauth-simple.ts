import nodemailer from 'nodemailer';
import dotenv from 'dotenv';

// Cargar variables de entorno
dotenv.config();

async function testGmailOAuth() {
    console.log('üß™ Probando Gmail OAuth2...\n');

    // Verificar variables de entorno
    const clientId = process.env.GMAIL_CLIENT_ID;
    const clientSecret = process.env.GMAIL_CLIENT_SECRET;
    const refreshToken = process.env.GMAIL_REFRESH_TOKEN;
    const user = process.env.GMAIL_USER;

    console.log('üìã Verificando configuraci√≥n:');
    console.log(`   Client ID: ${clientId ? '‚úÖ Configurado' : '‚ùå Falta'}`);
    console.log(`   Client Secret: ${clientSecret ? '‚úÖ Configurado' : '‚ùå Falta'}`);
    console.log(`   Refresh Token: ${refreshToken ? '‚úÖ Configurado' : '‚ùå FALTA - Debes obtenerlo'}`);
    console.log(`   Gmail User: ${user || 'daveymena16@gmail.com'}\n`);

    if (!refreshToken) {
        console.log('‚ùå ERROR: Falta el GMAIL_REFRESH_TOKEN');
        console.log('\nüìù Para obtenerlo:');
        console.log('   1. Ve a: https://developers.google.com/oauthplayground');
        console.log('   2. Configura tus credenciales OAuth (‚öôÔ∏è arriba derecha)');
        console.log('   3. Autoriza Gmail API v1 (https://mail.google.com/)');
        console.log('   4. Copia el Refresh Token');
        console.log('   5. Agr√©galo al .env como GMAIL_REFRESH_TOKEN=...\n');
        return;
    }

    try {
        console.log('üîß Creando transporter...');
        const transporter = nodemailer.createTransport({
            service: 'gmail',
            auth: {
                type: 'OAuth2',
                user: user || 'daveymena16@gmail.com',
                clientId,
                clientSecret,
                refreshToken,
            },
        });

        console.log('‚úÖ Transporter creado');
        console.log('üìß Enviando email de prueba...\n');

        const info = await transporter.sendMail({
            from: `"Tecnovariedades D&S" <${user || 'daveymena16@gmail.com'}>`,
            to: user || 'daveymena16@gmail.com',
            subject: '‚úÖ Gmail OAuth2 Funcionando',
            html: `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          <h2 style="color: #10b981;">üéâ ¬°Gmail OAuth2 Configurado Correctamente!</h2>
          <p>Tu sistema de emails est√° funcionando perfectamente.</p>
          <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <p><strong>‚úÖ Configuraci√≥n exitosa:</strong></p>
            <ul>
              <li>Gmail OAuth2 conectado</li>
              <li>Emails de verificaci√≥n listos</li>
              <li>Notificaciones de pago listas</li>
            </ul>
          </div>
          <p style="color: #6b7280; font-size: 14px;">
            Enviado desde: Smart Sales Bot Pro<br>
            Fecha: ${new Date().toLocaleString('es-CO')}
          </p>
        </div>
      `,
        });

        console.log('‚úÖ EMAIL ENVIADO EXITOSAMENTE!');
        console.log(`   Message ID: ${info.messageId}`);
        console.log(`   Destinatario: ${user || 'daveymena16@gmail.com'}`);
        console.log('\nüéâ Gmail OAuth2 est√° funcionando correctamente!');
        console.log('   Ahora puedes usar el sistema de emails en producci√≥n.\n');

    } catch (error: any) {
        console.error('‚ùå ERROR al enviar email:');
        console.error(`   ${error.message}\n`);

        if (error.message.includes('invalid_grant')) {
            console.log('üí° El refresh token expir√≥ o es inv√°lido.');
            console.log('   Genera uno nuevo en: https://developers.google.com/oauthplayground\n');
        } else if (error.message.includes('invalid_client')) {
            console.log('üí° Las credenciales OAuth son incorrectas.');
            console.log('   Verifica GMAIL_CLIENT_ID y GMAIL_CLIENT_SECRET\n');
        }
    }
}

testGmailOAuth();
